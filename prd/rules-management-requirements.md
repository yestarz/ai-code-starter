# 规则管理功能需求文档

## 1. 功能概述

在 ACS (AI Code Starter) 的 Web UI 界面中新增规则管理功能，支持统一创建、编辑、删除规则库中的规则，并将规则内容应用到全局或项目的规则文件中。

**注意**：本功能仅在 Web UI 界面中实现，不提供 CLI 命令接口。

## 2. 数据结构设计

### 2.1 配置文件结构

规则数据存储在 `~/.acs/config.json` 中，新增 `rules` 字段：

```json
{
  "language": "zh",
  "projects": [...],
  "cli": [...],
  "config": {...},
  "rules": [
    {
      "name": "规则1",
      "rule": "规则内容1（markdown格式）"
    },
    {
      "name": "规则2",
      "rule": "规则内容2（markdown格式）"
    }
  ]
}
```

### 2.2 CLI 工具映射关系

硬编码三种 CLI 工具，映射规则如下：

| CLI 工具 | 规则文件名 | 全局目录 | 全局文件路径 | 项目文件路径 |
|---------|----------|---------|------------|------------|
| Claude Code | `CLAUDE.md` | `~/.claude` | `~/.claude/CLAUDE.md` | `项目目录/CLAUDE.md` |
| Codex | `AGENTS.md` | `~/.codex` | `~/.codex/AGENTS.md` | `项目目录/AGENTS.md` |
| Gemini CLI | `GEMINI.md` | `~/.gemini` | `~/.gemini/GEMINI.md` | `项目目录/GEMINI.md` |

## 3. 功能需求

### 3.1 规则列表管理

#### 3.1.1 规则列表展示
- **位置**：Web UI 新增"规则管理"标签页
- **展示方式**：表格展示
- **表格列**：
  - **规则名称**：显示规则名称
  - **规则内容预览**：显示"[点击查看详情]"链接（点击后弹出详情弹窗）
  - **操作**：包含"编辑"、"删除"、"应用"三个按钮

#### 3.1.2 规则详情查看
- **触发方式**：点击"规则内容预览"列的"[点击查看详情]"
- **展示方式**：弹窗（Modal）
- **内容**：
  - 规则名称（可编辑）
  - 规则内容（Markdown 编辑器，支持编辑和预览）
  - 操作按钮：取消、保存

#### 3.1.3 规则新增
- **入口**：规则列表页面的"+ 新增规则"按钮
- **表单字段**：
  - **规则名称**（必填，文本输入）
  - **规则内容**（Markdown 编辑器，支持编辑和预览）
- **验证**：
  - 规则名称不能为空
  - 规则名称不能重复（在同一规则库中）
- **保存**：保存到 `config.json` 的 `rules` 数组中

#### 3.1.4 规则编辑
- **入口**：
  1. 规则列表表格的"编辑"按钮
  2. 规则详情弹窗中的编辑功能
- **表单**：同新增功能
- **验证**：同新增功能
- **更新**：更新 `config.json` 中对应规则

#### 3.1.5 规则删除
- **入口**：规则列表表格的"删除"按钮
- **确认机制**：删除前显示确认对话框（避免误删）
- **删除**：从 `config.json` 的 `rules` 数组中移除

### 3.2 规则应用功能

#### 3.2.1 应用入口
- **位置**：规则列表表格的"应用"按钮

#### 3.2.2 应用表单
- **弹窗标题**：应用规则：[规则名称]
- **表单字段**：
  1. **CLI 类型**（必选）
     - 下拉选择框（Select）
     - 选项：
       - Claude Code
       - Codex
       - Gemini CLI
  2. **应用范围**（必选）
     - 单选按钮组（Radio Group）
     - 选项：
       - 全局
       - 项目
  3. **选择项目**（条件显示）
     - 仅当"应用范围"选择"项目"时显示
     - 下拉选择框，从 `/api/projects` 接口获取项目列表（即 `acs ls` 命令显示的项目列表）
     - 选项格式：`项目名称 (项目路径)`
  4. **目标位置**（只读显示）
     - 根据选择动态显示目标文件路径
     - 格式示例：
       - 全局：`~/.claude/CLAUDE.md`
       - 项目：`D:\code\my\project\CLAUDE.md`

#### 3.2.3 二次确认
- **触发时机**：点击"确认应用"按钮后
- **确认内容**：
  - 显示：将规则"[规则名称]"应用到目标位置
  - 显示：目标文件路径
  - 提示：如果文件已存在，将自动创建备份文件
  - 按钮：取消、确认应用

#### 3.2.4 应用执行
- **文件备份**：
  - 写入前使用 `backupFileSync` 自动备份（如果文件已存在）
  - 备份文件名：`原文件名.bak`
- **文件写入**：
  - **全局**：写入到用户目录的对应 `.xxx` 目录
  - **项目**：写入到项目根目录
  - 如果目录不存在，自动创建
- **成功反馈**：显示成功提示消息
- **失败处理**：显示错误信息，并尝试恢复备份（如果备份存在）

### 3.3 Markdown 编辑器要求

#### 3.3.1 编辑功能
- 支持 Markdown 语法编辑
- 建议：代码高亮（可选）

#### 3.3.2 预览功能
- 支持实时预览功能
- 预览渲染：将 Markdown 转换为 HTML 展示
- 布局：编辑器和预览并排显示或切换标签显示

#### 3.3.3 实现建议
- 可选方案：
  - **简单方案**：textarea + Markdown 预览（切换标签）
  - **增强方案**：集成成熟的 Markdown 编辑器（如 marked + 简单编辑器）

## 4. UI/UX 设计要求

### 4.1 规则列表页面

```
┌─────────────────────────────────────────────────────┐
│  规则管理                                              │
├─────────────────────────────────────────────────────┤
│  [+ 新增规则]                                         │
├──────────┬────────────────────┬────────────────────┤
│ 规则名称  │ 规则内容预览         │ 操作                │
├──────────┼────────────────────┼────────────────────┤
│ 规则1    │ [点击查看详情]        │ [编辑] [删除] [应用]│
├──────────┼────────────────────┼────────────────────┤
│ 规则2    │ [点击查看详情]        │ [编辑] [删除] [应用]│
└──────────┴────────────────────┴────────────────────┘
```

### 4.2 规则详情/编辑弹窗

```
┌──────────────────────────────────────────────────┐
│  规则详情                            [X] 关闭      │
├──────────────────────────────────────────────────┤
│ 规则名称: [___________________]                    │
│                                                   │
│ 规则内容:                                         │
│ ┌──────────────┬──────────────────────────────┐ │
│ │ 编辑          │ 预览                         │ │
│ ├──────────────┼──────────────────────────────┤ │
│ │              │                              │ │
│ │ (Markdown    │  (渲染后的 HTML)             │ │
│ │  编辑器)      │                              │ │
│ │              │                              │ │
│ └──────────────┴──────────────────────────────┘ │
│                                                   │
│                          [取消]  [保存]           │
└──────────────────────────────────────────────────┘
```

### 4.3 应用规则弹窗

```
┌──────────────────────────────────────────────────┐
│  应用规则: 规则1                      [X] 关闭    │
├──────────────────────────────────────────────────┤
│ CLI 类型:                                         │
│   [Claude Code ▼]                                │
│     • Claude Code                                 │
│     • Codex                                       │
│     • Gemini CLI                                 │
│                                                   │
│ 应用范围:                                         │
│   ○ 全局  ● 项目                                  │
│                                                   │
│ 选择项目:                                         │
│   [项目A (D:\code\projectA) ▼]                    │
│                                                   │
│ 目标位置:                                         │
│   D:\code\projectA\CLAUDE.md                      │
│                                                   │
│                          [取消]  [确认应用]        │
└──────────────────────────────────────────────────┘
```

### 4.4 二次确认弹窗

```
┌──────────────────────────────────────────────────┐
│  确认应用规则                         [X] 关闭     │
├──────────────────────────────────────────────────┤
│ 将规则 "规则1" 应用到以下位置：                    │
│                                                   │
│ 目标文件: D:\code\projectA\CLAUDE.md              │
│                                                   │
│ 提示: 如果文件已存在，将自动创建备份文件。        │
│                                                   │
│                    [取消]  [确认应用]              │
└──────────────────────────────────────────────────┘
```

## 5. API 接口设计

**说明**：应用规则时所需的项目列表通过现有的 `/api/projects` 接口获取（该接口返回 `acs ls` 命令显示的项目列表）。

### 5.1 获取规则列表
- **接口**: `GET /api/rules`
- **响应**:
```json
{
  "success": true,
  "data": [
    {
      "name": "规则1",
      "rule": "规则内容1"
    }
  ]
}
```

### 5.2 新增规则
- **接口**: `POST /api/rules`
- **请求体**:
```json
{
  "name": "规则名称",
  "rule": "规则内容"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "name": "规则名称",
    "rule": "规则内容"
  }
}
```

### 5.3 更新规则
- **接口**: `PUT /api/rules/:name`
- **请求体**: 同新增接口
- **响应**: 同新增接口

### 5.4 删除规则
- **接口**: `DELETE /api/rules/:name`
- **响应**:
```json
{
  "success": true,
  "data": {
    "name": "规则名称"
  }
}
```

### 5.5 应用规则
- **接口**: `POST /api/rules/apply`
- **请求体**:
```json
{
  "ruleName": "规则名称",
  "cliCommand": "claude",
  "scope": "global",
  "projectPath": "D:\\code\\project" // scope为project时必需
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "ruleName": "规则名称",
    "cliCommand": "claude",
    "scope": "project",
    "projectPath": "D:\\code\\project",
    "targetPath": "D:\\code\\project\\CLAUDE.md"
  }
}
```

## 6. 技术实现要求

### 6.1 类型定义
- 在 `src/types.ts` 中定义 `Rule` 接口
- 更新 `AcsConfig` 接口，添加 `rules?: Rule[]` 字段

### 6.2 配置管理
- 更新 `src/config.ts` 中的 `configSchema`，添加 `rules` 字段验证
- 更新 `DEFAULT_CONFIG`，添加 `rules: []` 默认值

### 6.3 规则工具函数
- 创建 `src/utils/rules.ts` 文件
- 实现以下功能：
  - `getRuleFileName(cliCommand: string): string | null` - 根据 CLI 命令获取规则文件名
  - `getGlobalRuleDir(cliCommand: string): string | null` - 根据 CLI 命令获取全局规则目录
  - `writeGlobalRuleFile(cliCommand: string, content: string): void` - 写入全局规则文件
  - `writeProjectRuleFile(projectPath: string, cliCommand: string, content: string): void` - 写入项目规则文件

### 6.4 API 路由
- 在 `src/ui/routes.ts` 中添加 `handleRulesApi` 函数
- 在 `handleApiRequest` 中注册 `/api/rules` 路由

### 6.5 前端实现
- 在 `src/ui/public/app.js` 中添加规则管理标签页
- 实现表格展示、详情弹窗、编辑功能、应用功能
- 集成 Markdown 编辑器（编辑和预览功能）
- 项目列表通过调用 `/api/projects` 接口获取（复用现有的项目列表接口）

## 7. 错误处理

### 7.1 验证错误
- **规则名称为空**：返回 400 错误，提示"规则名称不能为空"
- **规则名称重复**：返回 409 错误，提示"规则名称已存在"
- **缺少必需参数**：返回 400 错误，提示具体缺失的参数

### 7.2 文件操作错误
- **项目路径不存在**：返回 400 错误，提示"项目路径不存在"
- **项目路径不是目录**：返回 400 错误，提示"项目路径不是目录"
- **文件写入失败**：返回 500 错误，提示具体错误信息
- **权限不足**：返回 500 错误，提示"文件写入权限不足"

### 7.3 业务逻辑错误
- **规则不存在**：返回 404 错误，提示"规则不存在"
- **不支持的 CLI 工具**：返回 400 错误，提示"不支持的 CLI 工具"
- **选择项目范围但未提供项目路径**：返回 400 错误，提示"选择项目范围时，projectPath 是必需的"

## 8. 边界情况处理

1. **规则内容为空**：允许保存，应用时写入空内容
2. **目标文件已存在**：应用前自动备份原文件
3. **目标目录不存在**：自动创建目录（全局和项目目录都需要）
4. **删除规则后应用该规则**：返回规则不存在错误
5. **CLI 工具命令包含参数**：提取基础命令名（如 `codex --flag` → `codex`）

## 9. 测试要求

### 9.1 单元测试
- 规则 CRUD 操作的测试
- 文件路径解析功能的测试
- 文件写入和备份功能的测试

### 9.2 集成测试
- API 接口测试
- 规则应用流程测试
- 错误处理测试

## 10. 后续扩展（可选功能）

- 规则分组/标签功能
- 应用历史记录
- 批量应用功能
- 规则模板库
- 规则导入/导出功能

---

**需求文档版本**：v1.0  
**创建日期**：2024  
**最后更新**：2024

